<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WSO2 Cloud</title>

    <!-- Bootstrap -->
    <link href="../css/bootstrap-3.2.0/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/fontwso2-1.2/css/font-wso2.css">
    <link href="../css/font-awesome-4.2.0/font-awesome.min.css" rel="stylesheet">
    <link href="../css/web-fonts/Roboto.css" rel="stylesheet">
    <link href="../css/datatables-1.10.7/jquery.dataTables.min.css" rel="stylesheet">
    <link href="../css/datatables-1.10.7/dataTables.responsive.css" rel="stylesheet">
    <link href="../css/datatables-1.10.7/jquery.dataTables.override.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- BOF cloud menu -->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="#" id="cloud-menu-popover-xs" data-toggle="popover" data-placement="bottom"
               class="hidden-md hidden-sm hidden-lg cloud-menu-popover">
                <i class="fw fw-tiles"></i>
            </a>
            <a class="navbar-brand" href="#"><img src="../images/logo.png" alt="wso2-logo" > Cloud</a>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav menu-right">
                <li><a href="#"><i class="fa fa-book"></i> Documentation</a></li>
                <li><a href="#about"><i class="fa fa-envelope"></i> Support</a></li>
                <li class="dropdown user-name">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">jack sparrow
                        <i class="fa fa-chevron-circle-down"></i>
                        <img src="../images/user.png" alt="user" class="user-image"></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="#">Profile</a></li>
                        <li><a href="#">Logout</a></li>
                    </ul>
                </li>
                <li class="cloud-menu hidden-xs">
                    <a href="#" id="cloud-menu-popover" data-toggle="popover" data-placement="bottom"
                            class="cloud-menu-popover">
                        <i class="fw fw-tiles"></i>
                    </a>
                </li>
            </ul>
            <!-- BOF cloud menu content -->
            <div class="cloud-menu-content hide">
                <div id="popover-head" class="hide">
                    Navigate to Cloud
                </div>
                <div id="popover-content" class="hide">
                   <div class="cloud-apps">
                       <a class="cloud-block">
                           <i class="fa fa-3x fa-cubes"></i>
                           <div class="cloud-name">Application Cloud</div>
                       </a>
                       <a class="cloud-block">
                           <i class="fw fw-api fa-3x"></i>
                           <div class="cloud-name">API Cloud</div>
                       </a>
                       <div class="clearfix"></div> <!-- to make seperate -->
                   </div>
                   <div class="cloud-actions">
                       <h3>Manage your cloud</h3>
                       <a class="cloud-block-invert">
                           <i class="fa fa-3x  fa-institution"></i>
                           <div class="cloud-name">Organizations</div>
                       </a>
                       <a class="cloud-block-invert">
                           <i class="fa fa-3x  fa-users"></i>
                           <div class="cloud-name">Members</div>
                       </a>
                       <a class="cloud-block-invert">
                           <i class="fa fa-3x  fa-envelope"></i>
                           <div class="cloud-name">Support</div>
                       </a>
                   </div>
                </div>
            </div>
            <!-- EOF cloud menu content -->
        </div><!--/.nav-collapse -->
    </div>
</div>
<!-- EOF cloud menu -->
<!-- BOF App factory menu -->
<div class="navbar navbar-secondary">
    <div class="container-fliud">
        <div class="row">
            <div class="side-pane-trigger">
                <i class="fa fa-reorder"></i>
            </div>
            <div class="breadcrumb-secondary">
                <i class="fa fa-cubes"></i> <span class="hidden-xs">Application Cloud </span> / My Java App / Runtime Configurations / APIs
            </div>
        </div>
    </div>
</div><!-- EOF App factory menu -->
<div class="inner-wrapper">
    <!-- left pane wrapper -->
    <div class="left-pane">
        <ul>
            <li>
                <a href="009_cloud_app_details_initial.html" target="_blank"><i class="fa fa-laptop"></i> Overview</a>
            </li>
            <li>
                <a href="team_initial.html"><i class="fa fa-users"></i> Team</a>
            </li>
            <li>
                <a><i class="fa fa-cogs"></i> Repository</a>
            </li>
            <li>
                <a href="#"><i class="fw fw-deploy"></i> Build & Deploy</a>
            </li>
            <li>
                <a href="database_initial.html"><i class="fa fa-database"></i> Databases</a>
            </li>
            <li class="selected">
                <a href="#"><i class="fa fa-wrench"></i> Runtime Configs</a>
            </li>
            <li>
                <a href="issues_initial.html"><i class="fa fa-tags"></i> Issues</a>
            </li>
            <li>
                <a href="#"><i class="fw fw-lifecycle"></i> Lifecycle Management</a>
            </li>
            <li>
                <a href="app_logs.html"><i class="fa fa-hdd-o"></i>Runtime Logs</a>
            </li>
            <li>
                <a href="custom_url_initial.html"><i class="fa fa-link"></i> Custom URL</a>
            </li>
            <li>
                <a href="application_settings.html"><i class="fw fw-settings"></i> Settings</a>
            </li>
        </ul>
    </div>

    <!-- left pane wrapper -->
    <div class="right-pane">


    <!-- BOF App factory menu actionbar -->
    <div class="action-bar">
        <a href="" class="btn-action">
                <span class="fw-stack fw-lg btn-action-ico">
                    <i class="fw fw-ring fw-stack-2x"></i>
                    <i class="fw fw-left-arrow fw-stack-1x"></i>
                </span> Back to Runtime configs
        </a>
        <a href="" class="btn-action">
                <span class="fw-stack fw-lg btn-action-ico">
                    <i class="fw fw-ring fw-stack-2x"></i>
                    <i class="fw fw-add fw-stack-1x"></i>
                </span> Add API
        </a>
    </div><!-- EOF App factory menu actionbar-->


    <div class="container-fluid app-content-section">
        <div class="row">
            <div class="col-md-12 msg-issues">
                Orem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor.
                Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.
                Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim.
                Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut,
                imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt.
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="push"></div>
                <div class="datatable">
                    <table id="apilist" class="display" cellspacing="0" width="100%">
                        <thead>
                        <tr>
                            <th>API Name</th>
                            <th>Version</th>
                            <th>Description</th>
                            <th>Provider</th>
                            <th>End Points</th>
                            <th>Authentication Details</th>
                            <th>Details</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div><!-- /.container -->


    </div>
    <div class="clearfix"></div>
    <div id="push"></div>
</div>
<div id="footer">
    <div class="container-fluid">
        <div class="footer-text">WSO2 Cloud V: 1.2 . &copy; 2015 <i class="fw fw-wso2 fw-2x"></i> All Rights Reserved.</div>
    </div>
</div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="../js/jquery-1.11.1/jquery.min.js"></script>
<script src="../js/datatables-1.10.7/jquery.dataTables.min.js"></script>
<script src="../js/datatables-1.10.7/dataTables.responsive.min.js"></script>
<script src="../js/Jeditable-1.7.3/jquery.jeditable.js"></script>
<script src="../js/datatables-1.10.7/jquery.dataTables.inlineEdit.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../js/datatables-1.10.7/jquery.dataTables.columnFilter.js"></script>
<script src="../js/bootstrap-3.2.0/bootstrap.min.js"></script>


<!-- include custom js functions -->
<script src="../js/custom/custom.js"></script>

<script>
    $('.side-pane-trigger').click(function(){
        var rightPane = $('.right-pane');
        var leftPane = $('.left-pane');
        if (rightPane.hasClass('visible')){
            rightPane.animate({"left":"0em"}, "slow").removeClass('visible');
            leftPane.animate({"left":"-18em"}, "slow");
            $(this).find('i').removeClass('fa-arrow-left').addClass('fa-reorder');
        } else {
            rightPane.animate({"left":"18em"}, "slow").addClass('visible');
            leftPane.animate({"left":"0em"}, "slow");
            $(this).find('i').removeClass('fa-reorder').addClass('fa-arrow-left');
        }
    });

    var apiListDataTable = $('#apilist').DataTable({
            responsive: true,
            "ajax": "objects_apis.json",
            "columns": [
                { "data": "apiname", "width": "10%"},
                { "data": "version", "width": "5%"},
                { "data": "description" , "width": "20%"},
                { "data": "provider" , "width": "20%"},
                { "data": "endpoints" , "width": "20%" , "sClass" : "details-control" },
                { "data": "auth-details", "orderable": false, "width": "20%", "sClass" : "details-control" },
                { "data": null, "orderable": false, "width": "20%", "sClass" : "dt-body-center"}
            ],
            "columnDefs": [
                {
                    "targets": 4,
                    "render": function ( data, type, full, meta ) {
                      return '<a href="#" data-type="endPoint" class="as-block">'+data+'</a>';
                    }
                },
                {
                    "targets": 5,
                    "render": function ( data, type, full, meta ) {
                        //data-auth-type attribute is required to identify the authentication type.
                        return '<a href="#" data-type="'+ data.replace(' ','') +'" class="as-block">'+data+'</a>';
                    }
                },
                { "targets": 6,"data": null,"defaultContent": "<a class='delete'><i class='fw fw-delete'></i></a>" }
            ]
    });

    var tableBody   = $('#apilist tbody');

    tableBody.on('click','td.details-control',function(){
        var tr              = $(this).closest('tr'),
            row             = apiListDataTable.row(tr),
            rowChild        = row.child,
            clickedCell     = apiListDataTable.cell(this).index(),
            cellType         = $(this).find('a').attr('data-type'),
            maxColumns      = apiListDataTable.columns().nodes().length;

        $('.highlight-parent-cell').removeClass('highlight-parent-cell');
        $(this).addClass('highlight-parent-cell');

        initializeAutheDetails(tr,row,rowChild,cellType,clickedCell,maxColumns)

    })

    function initializeAutheDetails(tr,row,rowChild,cellType,clickedCell,maxColumns){
        getJsonData('objects_runtime_configs_auth_details.json',function(response){

            if(rowChild.isShown()){
                var subTableCell = $(rowChild()).find('td').has('div').empty();
                subTableCell.first().addClass('highlight-table')
                        .append(format(cellType,response,clickedCell));
            }else{
                hideShownSubRows(tr);

                var fRowData = format(cellType,response,clickedCell),
                        childRow = row.child(fRowData),
                        childRowDOMObject = $(childRow.child());

                childRowDOMObject.addClass('highlight-table').find('td:first').removeAttr('colspan');
                positionCell(childRowDOMObject,maxColumns,clickedCell);
                childRow.show();
                tr.addClass('shown');
            }

        })
    }


    $(document).on( 'click', '.inline-edit', function () {
        $(this).editable(function(value,settings){
            if(value){
                inlineText = value;

                if(inlineText){
                    $(this).data(inlineText)
                }

                var editedCellHeader = $(this).closest('th').find('th').eq($(this).index()).text().replace(' ',''),
                    editedCellRow    = $('td:first', $(this).parents('tr')).text().replace(' ',''),
                    editedContent    = value,
                    parentHeader     = apiListDataTable.column(parseInt($(this).closest('table')
                                                       .attr('data-clicked-column'))).header().innerText.trim(),
                    parentRowObj     = apiListDataTable.row(parseInt($(this).closest('table')
                                                       .attr('data-clicked-row'))).data(),
                    parentRowId      = parentRowObj['api-id'],
                    editedContentObj = {},
                    parentObj        = {};

                editedContentObj['cellHeader'] = editedCellHeader;
                editedContentObj[editedCellRow] = editedContent;

                parentObj['id'] = parentRowId;
                parentObj[parentHeader] = editedContentObj;

                //TODO : Use the return to get the data object
                //console.log(parentObj);

                return value;
            }
        },{
            submit      : 'OK',
            indicator   : '<i class="fw fw-wso2-logo fw-pulse fw-2x"></i>',
            tooltip     : 'Click to edit...'
        })
    });

    /**
     *
     * Ajax Wrapper function to load json data
     *
     * @param fileName - This is basically the ajax url
     * @param callback - success callback when the ajax returns
     */
    function getJsonData(fileName,callback){
        $.ajax({
            url : fileName,
            type: 'GET',
            datatype: 'json',
            success: callback
        });
    }

    /**
     *
     * This function hides any other child rows that are showing
     *
     * @param row
     */
    function hideShownSubRows(row){
        $('td.details-control').parents('tr').each(function(){
            var currentRow = apiListDataTable.row(this);
            if(currentRow.child.isShown()){
                currentRow.child.hide();
                $(this).parent(row).find('.shown').removeClass('shown');
            }
        })
    }

    /**
     *
     * This function adds additional cells to make the subrow cell appear right under
     * the clicked parent cell
     *
     * @param obj - sub row that need cell appending
     * @param maxCols - maximum colums in the data table object
     * @param clickedCell - clicked cell in the data table
     */
    function positionCell(obj,maxCols,clickedCell){
        for(var i= 0; i < (maxCols-1); i++){
            if(i < clickedCell.column){
                obj.prepend('<td></td>');
            }else{
                obj.append('<td></td>');
            }
        }
    }

    /**
     *
     * This function generates a sub table according to the provided json data from
     * the tableData param
     *
     * @param rowType
     * @param tableData
     * @param clickedCell
     * @returns {string}
     */
    function format(rowType,tableData,clickedCell) {

        if('endPoint' == rowType) {
            var subTable = '<div class="subtable"><table data-clicked-parent-row="'+ clickedCell.row
                    +'" data-clicked-column="'+ clickedCell.column
                    +'"><tr><td class="inline-edit">https://wso2.com/t/dj/apiurl/1.3.1</td></tr></table>';

            return subTable;
        }

        var subTable = '<div class="subtable"><table data-clicked-parent-row="'+ clickedCell.row
                +'" data-clicked-column="'+ clickedCell.column +'">';
        tableData.forEach(function (rowObj) {
            if (rowObj.authType != rowType) {
                return;
            }
            var numOfPhases = rowObj.phases.length;
            rowObj.phases.forEach(function (phases) {
                var section = '';
                section += '<tr><th colspan="'+ numOfPhases+'">';
                section += phases.type;
                section += '</th></tr>'
                subTable += section;

                phases.keys.forEach(function (keys) {
                    var tableRow = '<tr>';
                    for (key in keys) {
                        tableRow += '<td>';
                        tableRow += key;
                        tableRow += '</td>';
                        tableRow += '<td class="inline-edit">';
                        tableRow += keys[key];
                        tableRow += '</td>';
                    }
                    tableRow += '</tr>';
                    subTable += tableRow;
                })
            })
        })
        return subTable += '</table></div>';
    }

</script>
</body>
</html>